<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®é‡ç½®å·¥å…· - ç”µæ± å”®åç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .tool-card { margin: 20px 0; }
        .status-info { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .status-success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .status-warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .status-danger { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-tools"></i> æ•°æ®é‡ç½®å·¥å…·
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>æ³¨æ„ï¼š</strong>æ­¤å·¥å…·ç”¨äºé‡ç½®å’Œä¿®å¤ç³»ç»Ÿæ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œï¼
                        </div>

                        <!-- å½“å‰çŠ¶æ€ -->
                        <div class="tool-card">
                            <h5>ğŸ“Š å½“å‰æ•°æ®çŠ¶æ€</h5>
                            <div id="currentStatus" class="status-info">
                                æ­£åœ¨æ£€æŸ¥...
                            </div>
                            <button class="btn btn-outline-primary" onclick="checkCurrentStatus()">
                                <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°çŠ¶æ€
                            </button>
                        </div>

                        <!-- æ•°æ®æ“ä½œ -->
                        <div class="tool-card">
                            <h5>ğŸ”§ æ•°æ®æ“ä½œ</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>é‡ç½®ä¸ºé»˜è®¤æ•°æ®</h6>
                                            <p class="text-muted">æ¸…é™¤æ‰€æœ‰æ•°æ®å¹¶åˆ›å»º5æ¡ç¤ºä¾‹è®°å½•</p>
                                            <button class="btn btn-warning" onclick="resetToDefault()">
                                                <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®æ•°æ®
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>æ¸…é™¤æ‰€æœ‰æ•°æ®</h6>
                                            <p class="text-muted">åˆ é™¤æ‰€æœ‰ç»´ä¿®è®°å½•æ•°æ®</p>
                                            <button class="btn btn-danger" onclick="clearAllData()">
                                                <i class="bi bi-trash"></i> æ¸…é™¤æ•°æ®
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ€§èƒ½ä¼˜åŒ– -->
                        <div class="tool-card">
                            <h5>âš¡ æ€§èƒ½ä¼˜åŒ–</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>æ¸…é™¤ç¼“å­˜</h6>
                                            <p class="text-muted">æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œåº”ç”¨ç¼“å­˜</p>
                                            <button class="btn btn-info" onclick="clearCache()">
                                                <i class="bi bi-speedometer2"></i> æ¸…é™¤ç¼“å­˜
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>æ€§èƒ½æµ‹è¯•</h6>
                                            <p class="text-muted">æµ‹è¯•ç³»ç»Ÿå“åº”é€Ÿåº¦</p>
                                            <button class="btn btn-success" onclick="performanceTest()">
                                                <i class="bi bi-stopwatch"></i> æ€§èƒ½æµ‹è¯•
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ“ä½œæ—¥å¿— -->
                        <div class="tool-card">
                            <h5>ğŸ“ æ“ä½œæ—¥å¿—</h5>
                            <div id="operationLog" class="border p-3" style="height: 200px; overflow-y: auto; background-color: #f8f9fa;">
                                <div class="text-muted">ç­‰å¾…æ“ä½œ...</div>
                            </div>
                            <button class="btn btn-outline-secondary mt-2" onclick="clearLog()">
                                <i class="bi bi-eraser"></i> æ¸…é™¤æ—¥å¿—
                            </button>
                        </div>

                        <!-- è¿”å›æŒ‰é’® -->
                        <div class="text-center mt-4">
                            <a href="index.html" class="btn btn-primary">
                                <i class="bi bi-house"></i> è¿”å›ä¸»é¡µ
                            </a>
                            <a href="records.html" class="btn btn-outline-primary">
                                <i class="bi bi-list-ul"></i> æŸ¥çœ‹è®°å½•
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="optimize_performance.js"></script>
    <script src="api.js"></script>
    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('operationLog');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-info';
            
            logDiv.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ£€æŸ¥å½“å‰çŠ¶æ€
        async function checkCurrentStatus() {
            log('æ£€æŸ¥å½“å‰æ•°æ®çŠ¶æ€...');
            
            try {
                const batteries = await BatteryAPI.getAllBatteries();
                const statusDiv = document.getElementById('currentStatus');
                
                if (batteries.length === 0) {
                    statusDiv.className = 'status-info status-warning';
                    statusDiv.innerHTML = `
                        <strong>âš ï¸ æ— æ•°æ®</strong><br>
                        å½“å‰ç³»ç»Ÿä¸­æ²¡æœ‰ç»´ä¿®è®°å½•æ•°æ®
                    `;
                } else {
                    const statusCounts = {};
                    batteries.forEach(battery => {
                        const status = battery.repairStatus || 'æœªçŸ¥';
                        statusCounts[status] = (statusCounts[status] || 0) + 1;
                    });
                    
                    statusDiv.className = 'status-info status-success';
                    statusDiv.innerHTML = `
                        <strong>âœ… æ•°æ®æ­£å¸¸</strong><br>
                        æ€»è®°å½•æ•°: ${batteries.length}<br>
                        çŠ¶æ€åˆ†å¸ƒ: ${Object.entries(statusCounts).map(([k,v]) => `${k}(${v})`).join(', ')}
                    `;
                }
                
                log(`çŠ¶æ€æ£€æŸ¥å®Œæˆï¼Œå…± ${batteries.length} æ¡è®°å½•`, 'success');
            } catch (error) {
                log(`çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('currentStatus').className = 'status-info status-danger';
                document.getElementById('currentStatus').innerHTML = `
                    <strong>âŒ æ£€æŸ¥å¤±è´¥</strong><br>
                    ${error.message}
                `;
            }
        }

        // é‡ç½®ä¸ºé»˜è®¤æ•°æ®
        async function resetToDefault() {
            if (!confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æ•°æ®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰ç°æœ‰æ•°æ®ï¼')) {
                return;
            }
            
            log('å¼€å§‹é‡ç½®ä¸ºé»˜è®¤æ•°æ®...');
            
            try {
                // æ¸…é™¤ç°æœ‰æ•°æ®
                localStorage.removeItem('batteries');
                if (window.StorageOptimizer) {
                    window.StorageOptimizer.clearCache();
                }
                
                // åˆ›å»ºé»˜è®¤æ•°æ®
                const batteries = await BatteryAPI.getAllBatteries();
                log(`æˆåŠŸåˆ›å»º ${batteries.length} æ¡é»˜è®¤è®°å½•`, 'success');
                
                // åˆ·æ–°çŠ¶æ€
                await checkCurrentStatus();
                
                alert('æ•°æ®é‡ç½®å®Œæˆï¼');
            } catch (error) {
                log(`é‡ç½®å¤±è´¥: ${error.message}`, 'error');
                alert('é‡ç½®å¤±è´¥: ' + error.message);
            }
        }

        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            log('æ¸…é™¤æ‰€æœ‰æ•°æ®...');
            
            try {
                localStorage.removeItem('batteries');
                if (window.StorageOptimizer) {
                    window.StorageOptimizer.clearCache();
                }
                
                log('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'success');
                checkCurrentStatus();
                alert('æ•°æ®æ¸…é™¤å®Œæˆï¼');
            } catch (error) {
                log(`æ¸…é™¤å¤±è´¥: ${error.message}`, 'error');
                alert('æ¸…é™¤å¤±è´¥: ' + error.message);
            }
        }

        // æ¸…é™¤ç¼“å­˜
        function clearCache() {
            log('æ¸…é™¤ç¼“å­˜...');
            
            try {
                if (window.StorageOptimizer) {
                    window.StorageOptimizer.clearCache();
                }
                
                // æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                        });
                    });
                }
                
                log('ç¼“å­˜æ¸…é™¤å®Œæˆ', 'success');
                alert('ç¼“å­˜æ¸…é™¤å®Œæˆï¼å»ºè®®åˆ·æ–°é¡µé¢ã€‚');
            } catch (error) {
                log(`æ¸…é™¤ç¼“å­˜å¤±è´¥: ${error.message}`, 'error');
                alert('æ¸…é™¤ç¼“å­˜å¤±è´¥: ' + error.message);
            }
        }

        // æ€§èƒ½æµ‹è¯•
        async function performanceTest() {
            log('å¼€å§‹æ€§èƒ½æµ‹è¯•...');
            
            try {
                const startTime = Date.now();
                
                // æµ‹è¯•æ•°æ®åŠ è½½
                const batteries = await BatteryAPI.getAllBatteries();
                const loadTime = Date.now() - startTime;
                
                // æµ‹è¯•æ•°æ®å¤„ç†
                const processStart = Date.now();
                const statusCounts = {};
                batteries.forEach(battery => {
                    const status = battery.repairStatus || 'æœªçŸ¥';
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                });
                const processTime = Date.now() - processStart;
                
                log(`æ€§èƒ½æµ‹è¯•ç»“æœ:`, 'success');
                log(`- æ•°æ®åŠ è½½æ—¶é—´: ${loadTime}ms`);
                log(`- æ•°æ®å¤„ç†æ—¶é—´: ${processTime}ms`);
                log(`- æ€»è®°å½•æ•°: ${batteries.length}`);
                
                if (loadTime < 100) {
                    log('âœ… æ€§èƒ½è‰¯å¥½', 'success');
                } else if (loadTime < 500) {
                    log('âš ï¸ æ€§èƒ½ä¸€èˆ¬', 'warning');
                } else {
                    log('âŒ æ€§èƒ½è¾ƒå·®ï¼Œå»ºè®®ä¼˜åŒ–', 'error');
                }
                
            } catch (error) {
                log(`æ€§èƒ½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLog() {
            document.getElementById('operationLog').innerHTML = '<div class="text-muted">æ—¥å¿—å·²æ¸…é™¤</div>';
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', function() {
            setTimeout(checkCurrentStatus, 500);
        });
    </script>
</body>
</html>
